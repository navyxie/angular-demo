"use strict";function redirectToLoginPage(){window.location.href=loginPage}function formatTime(e){var a=new Date(e),t=a.getFullYear()+"-"+(1+a.getMonth())+"-"+a.getDate()+" "+a.getHours()+":"+a.getMinutes();return t}function checkMobile(e){var a=RegExp(/^0?(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/);return a.test(e)}function isEmail(e){var a=/^(\w)+(\.\w+)*@(\w)+((\.\w+)+)$/;return a.test(e)}var loginPage="/p2p/login.html",maxAsset=1600,onceGetCashValue=10;angular.module("personApp").controller("PersonCtrl",function(e,a,t,s,o){t.dialogShow=0,t.isActiveGetCash=!1,t.isActiveShare=!1,t.isActiveSign=!1,t.showShareTip=!1,t.cashVal=0,t.dateList=[],t.showTaskList=!1,t.recordLists=[],t.totalAsset=0,t.showGetCashDialog=0,e.getCashInput=0,e.mobileTip=0,e.alipayAcountTip=0,e.getCashTip=0;var i=[{date:"第一天",money:"100",showSignImg:!1},{date:"第二天",money:"150",showSignImg:!1},{date:"第三天",money:"200",showSignImg:!1},{date:"第四天",money:"250",showSignImg:!1},{date:"第五天",money:"300",showSignImg:!1}],n={};e.personData={};var r=store.get("username");a.checkLogin(r,store.get("password"),function(a){if(0!==a.code)redirectToLoginPage();else{n.username=r,a=a.data[0],a.shared||(store.get("uploadshare")?s({url:"/api/aimibao_users/user_share",method:"POST",data:{username:store.get("username")}}).success(function(e){var a=t.totalAsset;a+=100,t.totalAsset=a;var s=t.recordLists;e.rData.data.cashflow.showTime=formatTime(e.rData.data.cashflow.create_time),s.splice(0,1,e.rData.data.cashflow),t.recordLists=s}).error(function(e){t.isActiveShare=!0,console.log(e)}):t.isActiveShare=!0),a.sign_day||(t.isActiveSign=!0,a.sign_day=0);for(var g=0;a.sign_day>g;g++)i[g].showSignImg=!0;t.dateList=i,t.showTaskList=!0,t.userInfo=a,o.getUserAsset({where:{user_id:a.id}},function(a){0!==a.code?alert("获取用户个人资产数据不成功"):(a=a.data[0],t.totalAsset=n.totalAsset=a.principal+a.sum_earnings,n.sumEarning=a.sum_earnings,n.yesterdayEaring=a.yesterday_income,t.cashVal=a.sum_earnings,a.sum_earnings>=3&&(t.isActiveGetCash=!0)),e.personData=n})}}),e.closeGetCashDialog=function(){t.showGetCashDialog=0,t.dialogShow=0},e.getAllEarn=function(){e.getCashInput=n.sumEarning},e.checkMobile=function(){var a=e.getUserMobile;e.mobileTip=checkMobile(a)?0:1},e.checkEmail=function(){var a=e.getAlipayAcount;e.alipayAcountTip=isEmail(a)||checkMobile(a)?0:1},e.checkGetCash=function(){e.getCashTip=isNaN(e.getCashInput)?1:0},e.$watch("getCashInput",function(){var a=e.getCashInput;0>a?a=0:a>=n.sumEarning?a=n.sumEarning:a>=onceGetCashValue&&(a=onceGetCashValue),e.getCashInput=a}),e.updateGetCash=function(){1!==e.alipayAcountTip&&1!==e.mobileTip&&1!==e.getCashTip&&s({url:"/api/aimibao_users/withdraw_cash",method:"POST",data:{username:store.get("username"),password:store.get("password"),userearn:e.getCashInput,alipayacount:e.getAlipayAcount,mobile:e.getUserMobile}}).success(function(a){console.log(a),t.totalAsset-=a.rData.data.asset.factCash,e.personData.sumEarning-=a.rData.data.asset.factCash;var s=t.recordLists;a.rData.data.cashflow.showTime=formatTime(a.rData.data.cashflow.create_time),s.splice(0,1,a.rData.data.cashflow),t.recordLists=s,e.closeGetCashDialog()}).error(function(e){console.log(e),alert("更新提现信息失败了，请重试")})}}).controller("TaskListCtrl",function(e,a,t,s){function o(){i||(i=!0,a({url:"/api/aimibao_users/user_sign",method:"POST",data:{username:store.get("username")}}).success(function(a){i=!1;var s=t.userInfo.sign_day?t.userInfo.sign_day+1:1;e.todayCash=t.dateList[s-1].money,e.tomorrowCash=t.dateList[s].money,t.dateList[s-1].showSignImg=!0;var o=t.totalAsset;o+=parseInt(e.todayCash),t.totalAsset=o;var n=t.recordLists;a.rData.data.cashflow.showTime=formatTime(a.rData.data.cashflow.create_time),n.splice(0,1,a.rData.data.cashflow),t.recordLists=n,t.isActiveSign=!1,e.signDialog=1,t.dialogShow=1}).error(function(e){console.log(e),i=!1,e.error&&-2===e.error.code?alert(e.error.msg):alert("服务器繁忙，请重试")}))}e.signDialog=0;var i=!1;e.signHander=function(){if(t.userInfo.sign){if(t.userInfo.sign_day>=5)return alert("已签到满五天了"),void 0;new Date(t.userInfo.sign).isToday()?(e.todayCash=t.dateList[t.userInfo.sign_day-1].money,e.tomorrowCash=t.dateList[t.userInfo.sign_day].money,e.signDialog=1,t.dialogShow=1):o()}else o()},e.closeSignDialog=function(){e.signDialog=0,t.dialogShow=0},s.getCashFlow({limit:5,order:"create_time DESC",where:{username:store.get("username")}},function(e){0!==e.code?alert("获取现金流不成功"):t.recordLists=_.each(e.data,function(e){return e.showTime=formatTime(e.create_time),e})}),e.getCashBtn=function(){t.isActiveGetCash?(t.showGetCashDialog=1,t.dialogShow=1):alert("收益必须满3元才能提现")},e.getSignCoin=function(){t.isActiveSign?e.signHander():alert("你已经做了新手签到零钱任务")},e.getShareCoin=function(){t.isActiveShare?(t.showShareTip=!0,store.set("userClickShareBtn",1)):alert("你已经领过分享奖励了")}});